<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Store Management System</title>
    <link href="css/admin.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .filter-input {
            margin-top: 5px;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.75rem;
            width: 100%;
            cursor: pointer;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        /* --- SIDEBAR DROPDOWN STYLES --- */
        .dropdown-btn {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dropdown-container {
            display: none;
            background-color: rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .dropdown-container a {
            padding-left: 45px !important;
            font-size: 0.85rem !important;
        }
        .show {
            display: block;
        }
        .rotate {
            transform: rotate(90deg);
        }
        .arrow-icon {
            transition: transform 0.2s;
            font-size: 0.7rem;
            font-style: normal;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-brand">ADMIN PANEL</div>
        <div class="sidebar-menu">
            <div class="menu-link dropdown-btn" onclick="toggleDropdown('dash-dropdown', 'arrow-dash')">
                <span><i>üìä</i> Dashboard Overview</span>
                <i class="arrow-icon" id="arrow-dash">‚ñ∂</i>
            </div>
            <div class="dropdown-container" id="dash-dropdown">
                <a href="admin.html" class="menu-link">‚óè SM MEGAMALL</a>
                <a href="admin_smne.html" class="menu-link active">‚óè SM NORTH EDSA</a>
            </div>
            
            <div class="menu-link dropdown-btn" onclick="toggleDropdown('trans-dropdown', 'arrow-trans')">
                <span><i>üí∏</i> Transactions</span>
                <i class="arrow-icon" id="arrow-trans">‚ñ∂</i>
            </div>
            <div class="dropdown-container" id="trans-dropdown">
                <a href="smmg_transactions.html" class="menu-link">‚óè SM MEGAMALL</a>
                <a href="#" class="menu-link">‚óè SM NORTH EDSA</a>
            </div>
            
            <a href="stock_management.html" class="menu-link"><i>üì¶</i> Stock Management</a>
            <a href="#" class="menu-link"><i>üìã</i> Inventory Reports</a>
            <a href="index.html" class="menu-link" style="margin-top: auto; color: #ff5e57;"><i>üö™</i> Logout</a>
        </div>
    </div>

    <div class="main-container">
        <div class="top-nav">
            <h3 style="color: var(--text-dark);">SM NORTH EDSA Store Analytics <span id="sync-status">Syncing...</span></h3>
            <div class="admin-profile" style="display: flex; align-items: center; gap: 15px;">
                <div style="text-align: right;">
                    <div style="font-weight: bold; font-size: 0.9rem;">Administrator</div>
                    <div style="font-size: 0.75rem; color: #808e9b;">Super User Access</div>
                </div>
                <span class="badge-admin">Admin</span>
            </div>
        </div>

        <div class="content-padding">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="label">TOTAL PRODUCT TYPES</span>
                    <span class="value" id="stat-total-items">0</span>
                    <span class="trend">Mula sa Sheets</span>
                </div>
                
                <div class="stat-card">
                    <span class="label">SALES BY DATE</span>
                    <span class="value" id="stat-sales-today">‚Ç±0.00</span>
                    <input type="date" id="date-selector" class="filter-input" onchange="updateStats(allInventoryData, allTransactionData)">
                </div>

                <div class="stat-card">
                    <span class="label">SALES BY MONTH</span>
                    <span class="value" id="stat-sales-month">‚Ç±0.00</span>
                    <input type="month" id="month-selector" class="filter-input" onchange="updateStats(allInventoryData, allTransactionData)">
                </div>
            </div>

            <div class="chart-container">
                <h2 style="margin:0 0 15px 0; font-size: 1rem; color: #2c3e50;">Daily Sales Trend (Last 7 Days)</h2>
                <canvas id="salesChart" height="100"></canvas>
            </div>
            
            <div class="controls-card">
                <input type="text" id="searchInput" class="search-box" placeholder="Search transaction ID or customer name..." oninput="filterTable()">
            </div>

            <div class="data-section">
                <div class="section-header">
                    <h2 style="margin:0; font-size: 1.2rem;">Recent Sales Transactions</h2>
                    <button class="btn-add" onclick="window.open('YOUR_GOOGLE_SHEET_URL_HERE', '_blank')">Open Google Sheets</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>SI Number</th>
                            <th>Customer Name</th>
                            <th>Total Amount</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                        <tr>
                            <td colspan="4" style="text-align:center; padding: 50px; color: #888;">Loading transaction data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbwoJ_5VDObaBae7N1GjVcEr6H1Mv_gwxvZlPuHWo_RyFCCbOvdq22Oym-G-aJ6p-y8/exec";
    
    let allInventoryData = []; 
    let allTransactionData = []; 
    let salesChart;

    // --- SIDEBAR DROPDOWN LOGIC (Improved for Multiple Dropdowns) ---
    function toggleDropdown(id, arrowId) {
        const dropdown = document.getElementById(id);
        const arrow = document.getElementById(arrowId);
        dropdown.classList.toggle("show");
        arrow.classList.toggle("rotate");
    }

    function setDefaultDates() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date-selector').value = `${year}-${month}-${day}`;
        document.getElementById('month-selector').value = `${year}-${month}`;
    }

    async function fetchInventory() {
        const syncStatus = document.getElementById('sync-status');
        const tableBody = document.getElementById('inventory-table-body');
        try {
            const response = await fetch(SHEETS_URL);
            const data = await response.json();
            if (data.error) {
                syncStatus.innerText = "Error: " + data.error;
                syncStatus.style.color = "var(--danger)";
                return;
            }
            allInventoryData = data.inventory || data;
            allTransactionData = data.transactions || []; 
            renderTable(allTransactionData);
            updateStats(allInventoryData, allTransactionData);
            updateChart(allTransactionData);
            syncStatus.innerText = "‚óè Live (Synced)";
            syncStatus.style.color = "var(--success)";
        } catch (error) {
            syncStatus.innerText = "Connection Error";
            syncStatus.style.color = "var(--danger)";
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Failed to load data.</td></tr>`;
        }
    }

    function renderTable(items) {
        const tableBody = document.getElementById('inventory-table-body');
        let html = "";
        if (!items || items.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">No matching transactions found.</td></tr>`;
            return;
        }
        items.slice(0, 50).forEach(item => {
            html += `
                <tr>
                    <td>${item.date}</td>
                    <td style="font-family:monospace; font-weight:bold;">${item.si}</td>
                    <td>${item.name}</td>
                    <td style="font-weight:bold; color: var(--primary);">‚Ç±${parseFloat(item.total).toFixed(2)}</td>
                </tr>
            `;
        });
        tableBody.innerHTML = html;
    }

    function updateStats(invItems, transItems) {
        document.getElementById('stat-total-items').innerText = invItems.length;
        const selectedDateRaw = document.getElementById('date-selector').value;
        const selectedMonthRaw = document.getElementById('month-selector').value;
        let salesSelectedDay = 0;
        let salesSelectedMonth = 0;
        transItems.forEach(t => {
            const tDate = new Date(t.date);
            const amount = parseFloat(t.total) || 0;
            const tFormattedDate = tDate.toISOString().split('T')[0];
            const tFormattedMonth = tFormattedDate.substring(0, 7);
            if (tFormattedDate === selectedDateRaw) salesSelectedDay += amount;
            if (tFormattedMonth === selectedMonthRaw) salesSelectedMonth += amount;
        });
        document.getElementById('stat-sales-today').innerText = `‚Ç±${salesSelectedDay.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('stat-sales-month').innerText = `‚Ç±${salesSelectedMonth.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function updateChart(transItems) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        const last7Days = [];
        const salesData = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            const compareStr = d.toISOString().split('T')[0];
            last7Days.push(dateStr);
            let dailyTotal = 0;
            transItems.forEach(t => {
                const tDateStr = new Date(t.date).toISOString().split('T')[0];
                if (tDateStr === compareStr) dailyTotal += parseFloat(t.total) || 0;
            });
            salesData.push(dailyTotal);
        }
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'Daily Sales (‚Ç±)',
                    data: salesData,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: { responsive: true }
        });
    }

    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredData = allTransactionData.filter(item => {
            const name = (item.name || "").toLowerCase();
            const si = (item.si || "").toLowerCase();
            return name.includes(searchTerm) || si.includes(searchTerm);
        });
        renderTable(filteredData);
    }

    window.onload = function() {
        setDefaultDates();
        fetchInventory();
        // Default: Open Dashboard dropdown
        document.getElementById("dash-dropdown").classList.add("show");
        document.getElementById("arrow-dash").classList.add("rotate");
    };
</script>
</body>
</html>