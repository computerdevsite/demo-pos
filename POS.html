<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM MEGAMALL - POS System</title>
    <link href="css/pos.css" rel="stylesheet">
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">SM MEGAMALL</div>
        <div class="sidebar-menu">
            <a href="POS.html" class="menu-item active"><i>üõí</i> Point of Sale</a>
            <a href="transactions.html" class="menu-item"><i>üìú</i> Transactions</a>
            <a href="delivery.html" class="menu-item"><i>üöö</i> Stock Delivery</a>
            <a href="pullout.html" class="menu-item"><i>üì§</i> Stock Pull Out</a>
            <a href="cashier_approvals.html" class="menu-item"><i>‚è≥</i> My Pending Stocks</a>
            <a href="stocks.html" class="menu-item"><i>üì¶</i> Check Stocks</a>
            <a href="index.html" class="menu-item" style="margin-top: auto;"><i>üö™</i> Logout</a>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div style="font-weight: 600; color: var(--primary);">CASHIER TRANSACTION MODE <span id="loading-indicator">(Syncing Sheets...)</span></div>
            <div class="cashier-info">
                <span id="active-user" style="font-size: 0.9rem; font-weight: 500;">Active User</span>
                <span class="badge-cashier">CASHIER ROLE</span>
            </div>
        </div>

        <div class="pos-wrapper">
            <div class="left-panel">
                <h3 style="margin-top:0; color: var(--primary);">Customer & Invoice Information</h3>
                <div class="grid-3">
                    <div class="form-group"><label>Date</label><input type="text" id="si_date" placeholder="MM/DD/YYYY"></div>
                    <div class="form-group"><label>SI Number</label><input type="text" id="si_number" placeholder="SI-1001"></div>
                    <div class="form-group"><label>TIN</label><input type="text" id="tin_number" placeholder="000-000-000"></div>
                </div>
                <div class="form-group"><label>Customer Name</label><input type="text" id="cust_name" placeholder="Name of Customer"></div>
                <div class="form-group"><label>Address</label><input type="text" id="cust_address" placeholder="Customer Address"></div>

                <div class="barcode-section">
                    <label style="color:var(--accent);">Scan Item Barcode</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="item_barcode" class="barcode-input" oninput="searchInventory()" onkeypress="handleEnter(event)" autofocus>
                        <button onclick="addItem()" style="padding:0 20px; background:var(--accent); color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">ENTER</button>
                    </div>
                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-top:10px;">
                        <input type="text" id="item_name" readonly placeholder="Item Description" style="background:#eee;">
                        <input type="text" id="item_price" readonly placeholder="‚Ç± 0.00" style="background:#eee;">
                    </div>
                </div>

                <div style="margin-top: auto; padding-top: 5px; display: flex; justify-content: space-evenly; align-items: center;">
                    <div class="">
                        <div class="cashier-op">
                            <label>SERVICE FEE</label>
                            <input type="number" id="service_fee_input" placeholder="0.00" onkeypress="handleServiceEnter(event)" oninput="updateUI()">
                        </div>
                    </div>

                    <div class="">
                        <label>Customer type</label>
                        <div class="cashier-grid1">
                            <label class="cashier-opt"><input type="radio" name="customer" value="IAYC SERVICE FEE" onchange="updateUI()">IAYC</label>
                            <label class="cashier-opt"><input type="radio" name="customer" value="NON-IAYC SERVICE FEE" checked onchange="updateUI()">NON-IAYC</label>
                        </div>
                    </div>
                </div>

                <div style="margin-top: auto; padding-top: 20px;">
                    <label>Verify Seller ID</label>
                    <div class="cashier-grid">
                        <label class="cashier-opt"><input type="radio" name="cashier" value="ARENAS" onchange="updateUI()">ARENAS</label>
                        <label class="cashier-opt"><input type="radio" name="cashier" value="CLIMACO" onchange="updateUI()">CLIMACO</label>
                        <label class="cashier-opt"><input type="radio" name="cashier" value="KING KING" onchange="updateUI()">KING KING</label>
                        <label class="cashier-opt"><input type="radio" name="cashier" value="BUEMIO" onchange="updateUI()">BUEMIO</label>
                        <label class="cashier-opt"><input type="radio" name="cashier" value="BROZO" onchange="updateUI()">BROZO</label>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <h3 style="margin:0; font-weight: 500;">Transaction Summary</h3>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;" id="preview-meta">Date: --- | Seller: ---</div>
                
                <div class="cart-container" id="cart-list"></div>

                <div class="total-section">
                    <div class="form-group">
                        <label style="color: #bdc3c7;">Discount (‚Ç±)</label>
                        <input type="number" id="manual_discount" value="" oninput="updateUI()" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color:white;">
                    </div>

                    <div class="form-group">
                        <label style="color: #bdc3c7;">Other Deductions (‚Ç±)</label>
                        <input type="number" id="other_deductions" value="" oninput="updateUI()" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color:white;">
                    </div>

                    <div class="total-row"><span>Subtotal:</span><span id="subtotal-val">‚Ç±0.00</span></div>
                    <div class="total-row" style="color:#f1c40f;"><span>Total Deductions:</span><span id="discount-val">-‚Ç±0.00</span></div>

                    <div class="grand-total" style="font-weight: normal; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                        <div class="total-row" style="color:white;"><span>VATable Sales:</span><span id="VATable-val">‚Ç±0.00</span></div>
                    </div>

                    <div class="grand-total" style="font-weight: normal; border-top: none; margin-top: -10px;">
                        <div class="total-row" style="color:white;"><span>VAT (12%):</span><span id="VAT-val">‚Ç±0.00</span></div>
                    </div>

                    <div class="grand-total" style="border-top: 2px solid white; margin-top: 5px; padding-top: 10px;">
                        <span>TOTAL</span>
                        <span id="total-val">‚Ç±0.00</span>
                    </div>
                    <button class="btn-save" onclick="processInvoice()">COMPLETE SALE</button>
                    <button onclick="emptyCart()" style="width:100%; background:none; border:none; color:#bdc3c7; cursor:pointer; margin-top:10px; font-size:0.8rem;">Void Transaction</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEETS_URL = "https://script.google.com/macros/s/AKfycbwwkcQnmXYG_E3Z9rJGyZ9dlluJ9nPFs9GeWZt211ZyEbN0wxHf9MFjXRE6NLh0fh0t/exec";

        let inventory = []; 
        let cart = [];

        window.onload = function() {
            const dateInput = document.getElementById('si_date');
            if (dateInput) {
                const today = new Date();
                const formattedDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                     today.getDate().toString().padStart(2, '0') + '/' + 
                                     today.getFullYear();
                dateInput.value = formattedDate;
            }
            fetchInventory();
        };

        // --- DATA FETCHING ---
        async function fetchInventory() {
            const indicator = document.getElementById('loading-indicator');
            if(indicator) {
                indicator.style.display = 'inline';
                indicator.innerText = "(Connecting...)";
            }
            
            try {
                // Pinapasa ang action=getAdminData para makuha ang buong dataset kasama inventory
                const response = await fetch(SHEETS_URL + "?action=getAdminData&t=" + new Date().getTime());
                const result = await response.json();
                
                if (result.error) {
                    if(indicator) indicator.innerText = "(" + result.error + ")";
                } else {
                    // Update: Kinukuha ang inventory property mula sa unified result
                    inventory = result.inventory || []; 
                    
                    if(indicator) {
                        indicator.innerText = "(Sheets Linked: " + inventory.length + " items)";
                        indicator.style.color = "#27ae60";
                    }
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                if(indicator) {
                    indicator.innerText = "(Connection Error)";
                    indicator.style.color = "#e74c3c";
                }
            }
        }

        // --- SEARCH & ADD ---
        function searchInventory() {
            const barcodeInput = document.getElementById('item_barcode');
            const bcValue = barcodeInput.value.trim();
            barcodeInput.classList.remove('invalid-field');

            const item = inventory.find(i => String(i.barcode).trim() === bcValue);

            if (item) {
                document.getElementById('item_name').value = item.name;
                document.getElementById('item_price').value = parseFloat(item.price).toFixed(2);
            } else {
                document.getElementById('item_name').value = "";
                document.getElementById('item_price').value = "";
            }
        }

        function handleEnter(e) { 
            if (e.key === "Enter") {
                e.preventDefault();
                addItem(); 
            }
        }

        function addItem() {
            const barcodeInput = document.getElementById('item_barcode');
            const name = document.getElementById('item_name').value;
            const priceStr = document.getElementById('item_price').value;
            const price = parseFloat(priceStr);
            const barcodeValue = barcodeInput.value.trim();

            if (!name || isNaN(price)) {
                barcodeInput.classList.add('invalid-field');
                return;
            }

            barcodeInput.classList.remove('invalid-field');
            cart.push({ id: Date.now(), barcode: barcodeValue, name: name, price: price, qty: 1 });
            
            barcodeInput.value = '';
            document.getElementById('item_name').value = '';
            document.getElementById('item_price').value = '';
            barcodeInput.focus();
            updateUI();
        }

        // --- SERVICE FEE (IAYC / NON-IAYC) ---
        function handleServiceEnter(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                addServiceFee();
            }
        }

        function addServiceFee() {
            const feeInput = document.getElementById('service_fee_input');
            const selectedType = document.querySelector('input[name="customer"]:checked');
            const feeAmount = parseFloat(feeInput.value);
            
            if (isNaN(feeAmount) || feeAmount <= 0) {
                alert("Please enter a valid Service Fee amount.");
                return;
            }

            if (!selectedType) {
                alert("Please select a Customer Type.");
                return;
            }

            cart.push({
                id: Date.now(),
                barcode: "SERVICE",
                name: selectedType.value,
                price: feeAmount,
                qty: 1
            });

            feeInput.value = '';
            updateUI();
        }

        function removeItem(id) {
            cart = cart.filter(i => i.id !== id);
            updateUI();
        }

        // --- UI UPDATES ---
        function updateUI() {
            const list = document.getElementById('cart-list');
            const disc = parseFloat(document.getElementById('manual_discount').value) || 0;
            const otherDed = parseFloat(document.getElementById('other_deductions').value) || 0;
            
            const dateInput = document.getElementById('si_date').value || "---";
            const cashierInput = document.querySelector('input[name="cashier"]:checked');
            const cashierName = cashierInput ? cashierInput.value : "---";
            
            document.getElementById('preview-meta').innerText = `Date: ${dateInput} | Seller: ${cashierName}`;

            let sub = 0;
            let html = '<div class="cart-row cart-header"><span>#</span><span>Barcode</span><span>Item</span><span>Price</span><span></span></div>';
            
            cart.forEach((item, i) => {
                sub += item.price;
                html += `<div class="cart-row">
                    <span>${i+1}</span>
                    <span class="cart-barcode">${item.barcode}</span>
                    <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.name}</span>
                    <span>‚Ç±${item.price.toFixed(2)}</span>
                    <button class="btn-remove" onclick="removeItem(${item.id})">‚úï</button>
                </div>`;
            });

            list.innerHTML = html;
            
            const totalDeductions = disc + otherDed;
            const finalTotal = Math.max(0, sub - totalDeductions);
            
            document.getElementById('subtotal-val').innerText = `‚Ç±${sub.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('discount-val').innerText = `-‚Ç±${totalDeductions.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('total-val').innerText = `‚Ç±${finalTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            
            const vatableAmount = finalTotal / 1.12;
            const vatAmount = finalTotal - vatableAmount;

            document.getElementById('VATable-val').innerText = `‚Ç±${vatableAmount.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('VAT-val').innerText = `‚Ç±${vatAmount.toLocaleString(undefined, {minimumFractionDigits: 2})}`;

            list.scrollTop = list.scrollHeight;
        }

        function emptyCart() { if(confirm("Void current transaction?")) { cart = []; updateUI(); } }

        // --- FINAL PROCESS INVOICE ---
        async function processInvoice() {
            const btnSave = document.querySelector('.btn-save');
            const date = document.getElementById('si_date').value;
            const si = document.getElementById('si_number').value;
            const name = document.getElementById('cust_name').value;
            const feeInput = document.getElementById('service_fee_input');
            const cashierInput = document.querySelector('input[name="cashier"]:checked');

            if (!cashierInput) {
                alert("Paki-pili muna ang pangalan ng Cashier bago i-save!");
                return;
            }

            // Guard para sa hindi na-enter na service fee
            if (feeInput && feeInput.value.trim() !== "" && parseFloat(feeInput.value) > 0) {
                const confirmFee = confirm("May amount sa Service Fee box. Isasama ba ito?");
                if (confirmFee) addServiceFee();
                else { feeInput.focus(); return; }
            }

            if (!date || !si || !name || cart.length === 0) {
                alert("Kulang ang data o walang laman ang cart!");
                return;
            }

            const totalDisplay = document.getElementById('total-val').innerText;
            const totalValue = parseFloat(totalDisplay.replace(/[‚Ç±,]/g, '')) || 0;

            const vatableSales = (totalValue / 1.12).toFixed(2);
            const vatAmount = (totalValue - parseFloat(vatableSales)).toFixed(2);

            btnSave.innerText = "SAVING...";
            btnSave.disabled = true;

            const transactionData = {
                action: "save_transaction", 
                date: date,
                si: si,
                tin: document.getElementById('tin_number').value || "N/A",
                name: name,
                address: document.getElementById('cust_address').value || "N/A",
                seller: cashierInput.value,
                total: totalValue.toFixed(2),
                vatable_sales: vatableSales,
                vat_amount: vatAmount,
                items: cart 
            };

            try {
                await fetch(SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    body: JSON.stringify(transactionData)
                });

                alert("SUCCESS: Transaction Saved!");
                await fetchInventory(); 

                // Reset
                const cashiers = document.querySelectorAll('input[name="cashier"]');
                cashiers.forEach(radio => radio.checked = false);
                cart = [];
                ["si_number", "cust_name", "cust_address", "tin_number", "service_fee_input", "other_deductions", "manual_discount"].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.value = (id.includes('discount') || id.includes('deduction')) ? "0" : "";
                });
                updateUI();
                
            } catch (error) {
                alert("CONNECTION ERROR!");
            } finally {
                btnSave.innerText = "COMPLETE SALE";
                btnSave.disabled = false;
            }
        }
    </script>
</body>
</html>