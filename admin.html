<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Store Management System</title>
    <link href="css/admin.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .filter-input {
            margin-top: 5px;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.75rem;
            width: 100%;
            cursor: pointer;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        /* Adjusted grid to 3 columns since Low Stock is removed */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-brand">ADMIN PANEL</div>
        <div class="sidebar-menu">
            <a href="admin.html" class="menu-link active"><i>üìä</i> SM MEGAMALL<br>Dashboard Overview</a>
            <a href="#" class="menu-link"><i>üìä</i> SM NORTH EDSA<br>Dashboard Overview</a>
            <a href="stock_management.html" class="menu-link"><i>üì¶</i> Stock Management</a>
            <a href="#" class="menu-link"><i>üìã</i> Inventory Reports</a>
            <a href="index.html" class="menu-link" style="margin-top: auto; color: #ff5e57;"><i>üö™</i> Logout</a>
        </div>
    </div>

    <div class="main-container">
        <div class="top-nav">
            <h3 style="color: var(--text-dark);">SM MEGAMALL Store Analytics <span id="sync-status">Syncing...</span></h3>
            <div class="admin-profile" style="display: flex; align-items: center; gap: 15px;">
                <div style="text-align: right;">
                    <div style="font-weight: bold; font-size: 0.9rem;">Administrator</div>
                    <div style="font-size: 0.75rem; color: #808e9b;">Super User Access</div>
                </div>
                <span class="badge-admin">Admin</span>
            </div>
        </div>

        <div class="content-padding">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="label">TOTAL PRODUCT TYPES</span>
                    <span class="value" id="stat-total-items">0</span>
                    <span class="trend">Mula sa Sheets</span>
                </div>
                
                <div class="stat-card">
                    <span class="label">SALES BY DATE</span>
                    <span class="value" id="stat-sales-today">‚Ç±0.00</span>
                    <input type="date" id="date-selector" class="filter-input" onchange="updateStats(allInventoryData, allTransactionData)">
                </div>

                <div class="stat-card">
                    <span class="label">SALES BY MONTH</span>
                    <span class="value" id="stat-sales-month">‚Ç±0.00</span>
                    <input type="month" id="month-selector" class="filter-input" onchange="updateStats(allInventoryData, allTransactionData)">
                </div>
            </div>

            <div class="chart-container">
                <h2 style="margin:0 0 15px 0; font-size: 1rem; color: #2c3e50;">Daily Sales Trend (Last 7 Days)</h2>
                <canvas id="salesChart" height="100"></canvas>
            </div>
            
            <div class="controls-card">
                <input type="text" id="searchInput" class="search-box" placeholder="Search transaction ID or customer name..." oninput="filterTable()">
            </div>

            <div class="data-section">
                <div class="section-header">
                    <h2 style="margin:0; font-size: 1.2rem;">Recent Sales Transactions</h2>
                    <button class="btn-add" onclick="window.open('YOUR_GOOGLE_SHEET_URL_HERE', '_blank')">Open Google Sheets</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>SI Number</th>
                            <th>Customer Name</th>
                            <th>Total Amount</th>
                            <th>Cashier</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                        <tr>
                            <td colspan="5" style="text-align:center; padding: 50px; color: #888;">Loading transaction data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbzpArDNWwE8sDpmSX8BFpnBNtBM7EWIYic55PjFMnEpsX8iH7Nm7lWIk76OFZIH85ZW/exec";
    
    let allInventoryData = []; 
    let allTransactionData = []; 
    let salesChart;

    function setDefaultDates() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        
        document.getElementById('date-selector').value = `${year}-${month}-${day}`;
        document.getElementById('month-selector').value = `${year}-${month}`;
    }

    async function fetchInventory() {
        const syncStatus = document.getElementById('sync-status');
        const tableBody = document.getElementById('inventory-table-body');
        
        try {
            const response = await fetch(SHEETS_URL);
            const data = await response.json();

            if (data.error) {
                syncStatus.innerText = "Error: " + data.error;
                syncStatus.style.color = "var(--danger)";
                return;
            }

            allInventoryData = data.inventory || data;
            allTransactionData = data.transactions || []; 

            renderTable(allTransactionData);
            updateStats(allInventoryData, allTransactionData);
            updateChart(allTransactionData);
            
            syncStatus.innerText = "‚óè Live (Synced)";
            syncStatus.style.color = "var(--success)";

        } catch (error) {
            syncStatus.innerText = "Connection Error";
            syncStatus.style.color = "var(--danger)";
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Failed to load data.</td></tr>`;
        }
    }

    function renderTable(items) {
        const tableBody = document.getElementById('inventory-table-body');
        let html = "";
        if (!items || items.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px;">No matching transactions found.</td></tr>`;
            return;
        }
        items.slice(0, 50).forEach(item => {
            html += `
                <tr>
                    <td>${item.date}</td>
                    <td style="font-family:monospace; font-weight:bold;">${item.si}</td>
                    <td>${item.name}</td>
                    <td style="font-weight:bold; color: var(--primary);">‚Ç±${parseFloat(item.total).toFixed(2)}</td>
                    <td><span class="badge-admin" style="background:#e1eaf2; color:#2c3e50; font-size:0.7rem;">${item.seller}</span></td>
                </tr>
            `;
        });
        tableBody.innerHTML = html;
    }

    function updateStats(invItems, transItems) {
        // Updated: Only Total Items and Sales calculations
        document.getElementById('stat-total-items').innerText = invItems.length;

        const selectedDateRaw = document.getElementById('date-selector').value;
        const selectedMonthRaw = document.getElementById('month-selector').value;

        let salesSelectedDay = 0;
        let salesSelectedMonth = 0;

        transItems.forEach(t => {
            const tDate = new Date(t.date);
            const amount = parseFloat(t.total) || 0;
            const transYear = tDate.getFullYear();
            const transMonth = String(tDate.getMonth() + 1).padStart(2, '0');
            const transDay = String(tDate.getDate()).padStart(2, '0');
            const tFormattedDate = `${transYear}-${transMonth}-${transDay}`;
            const tFormattedMonth = `${transYear}-${transMonth}`;

            if (tFormattedDate === selectedDateRaw) salesSelectedDay += amount;
            if (tFormattedMonth === selectedMonthRaw) salesSelectedMonth += amount;
        });

        document.getElementById('stat-sales-today').innerText = `‚Ç±${salesSelectedDay.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('stat-sales-month').innerText = `‚Ç±${salesSelectedMonth.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function updateChart(transItems) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        const last7Days = [];
        const salesData = [];

        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            const compareStr = d.toISOString().split('T')[0];
            last7Days.push(dateStr);

            let dailyTotal = 0;
            transItems.forEach(t => {
                const tDateStr = new Date(t.date).toISOString().split('T')[0];
                if (tDateStr === compareStr) dailyTotal += parseFloat(t.total) || 0;
            });
            salesData.push(dailyTotal);
        }

        if (salesChart) salesChart.destroy();

        salesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'Daily Sales (‚Ç±)',
                    data: salesData,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, ticks: { callback: value => '‚Ç±' + value.toLocaleString() } }
                }
            }
        });
    }

    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredData = allTransactionData.filter(item => {
            const name = (item.name || "").toLowerCase();
            const si = (item.si || "").toLowerCase();
            return name.includes(searchTerm) || si.includes(searchTerm);
        });
        renderTable(filteredData);
    }

    window.onload = function() {
        setDefaultDates();
        fetchInventory();
    };
</script>
</body>
</html>