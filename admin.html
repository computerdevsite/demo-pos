<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Store Management System</title>
    <link href="css/admin.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- NEW STORE SELECTOR STYLES --- */
        .header-with-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .store-dropdown {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #dcdde1;
            background-color: white;
            font-weight: bold;
            color: #2f3640;
            cursor: pointer;
            outline: none;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .store-dropdown:focus {
            border-color: #3498db;
        }

        /* --- PREVIOUS STYLES --- */
        .filter-input {
            margin-top: 5px;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.75rem;
            width: 100%;
            cursor: pointer;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .sidebar-badge {
            background: #ff3f34;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
            display: none;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-brand">ADMIN PANEL</div>
        <div class="sidebar-menu">
            <a href="admin.html" class="menu-link active"><i>ðŸ“Š</i> Dashboard</a>
            <a href="pending.html" class="menu-link">
                <i>âœ…</i> Pending Approvals <span class="sidebar-badge" id="main-pending-badge">0</span>
            </a>
            <a href="smmg_transactions.html" class="menu-link"><i>ðŸ’¸</i> Transactions</a>
            <a href="transfer.html" class="menu-link"><i>ðŸ”„</i> Stock Transfer</a>
            <a href="stock_management.html" class="menu-link"><i>ðŸ“¦</i> Stock Management</a>
            <a href="index.html" class="menu-link" style="margin-top: auto; color: #ff5e57;"><i>ðŸšª</i> Logout</a>
        </div>
    </div>

    <div class="main-container">
        <div class="top-nav">
            <div class="header-with-selector">
                <h3 style="color: var(--text-dark); margin: 0;">Store Analytics:</h3>
                <select id="branch-selector" class="store-dropdown" onchange="changeBranch()">
                    <option value="MEGAMALL" selected>SM MEGAMALL</option>
                    <option value="NORTH_EDSA">SM NORTH EDSA</option>
                </select>
                <span id="sync-status" style="font-size: 0.8rem; margin-left: 10px;">Syncing...</span>
            </div>

            <div class="admin-profile" style="display: flex; align-items: center; gap: 15px;">
                <div style="text-align: right;">
                    <div style="font-weight: bold; font-size: 0.9rem;">Administrator</div>
                    <div style="font-size: 0.75rem; color: #808e9b;">Super User Access</div>
                </div>
                <span class="badge-admin">Admin</span>
            </div>
        </div>

        <div class="content-padding">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="label">TOTAL PRODUCT TYPES</span>
                    <span class="value" id="stat-total-items">0</span>
                    <span class="trend">Mula sa Sheets</span>
                </div>
                
                <div class="stat-card">
                    <span class="label">SALES BY DATE</span>
                    <span class="value" id="stat-sales-today">â‚±0.00</span>
                    <input type="date" id="date-selector" class="filter-input" onchange="updateStats(allInventoryData, allTransactionData)">
                </div>

                <div class="stat-card">
                    <span class="label">SALES BY MONTH</span>
                    <span class="value" id="stat-sales-month">â‚±0.00</span>
                    <input type="month" id="month-selector" class="filter-input" onchange="updateStats(allInventoryData, allTransactionData)">
                </div>
            </div>

            <div class="chart-container">
                <h2 style="margin:0 0 15px 0; font-size: 1rem; color: #2c3e50;">Daily Sales Trend (Last 7 Days)</h2>
                <canvas id="salesChart" height="100"></canvas>
            </div>
            
            <div class="controls-card">
                <input type="text" id="searchInput" class="search-box" placeholder="Search transaction ID or customer name..." oninput="filterTable()">
            </div>

            <div class="data-section">
                <div class="section-header">
                    <h2 id="table-title" style="margin:0; font-size: 1.2rem;">Recent Sales: SM MEGAMALL</h2>
                    <button class="btn-add" onclick="openSheet()">Open Google Sheets</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>SI Number</th>
                            <th>Customer Name</th>
                            <th>Total Amount</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                        <tr>
                            <td colspan="4" style="text-align:center; padding: 50px; color: #888;">Loading transaction data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // CONFIGURATION
    const BRANCH_CONFIG = {
            'MEGAMALL': {
                url: "https://script.google.com/macros/s/AKfycbwwkcQnmXYG_E3Z9rJGyZ9dlluJ9nPFs9GeWZt211ZyEbN0wxHf9MFjXRE6NLh0fh0t/exec",
                label: "Megamall Branch",
                sheetUrl: "https://docs.google.com/spreadsheets/d/1XF6e2Q_vD_R2_61U0-oA9S30Uu4e565P6I3-T-q-T-k/edit"
            },
            'NORTH_EDSA': {
                url: "https://script.google.com/macros/s/AKfycbxKnZHePSbSMqf1G_lcnF867kEL6Idq6yNEBWiu2XtklhljQlCnloSshXHXNoHY6wUi/exec",
                label: "North Edsa Branch",
                sheetUrl: "https://docs.google.com/spreadsheets/d/1N_f_H8h6-6vXk6v-q0O-Oq0Oq0Oq0Oq0Oq0Oq0Oq0/edit"
            }
        };

    const PENDING_API_URL = "https://script.google.com/macros/s/AKfycbzY8_i2U7WRe7Z6Dm4dVv0-L26QbnSW4gQETNPATCthogPIpAomKiSXVaRZbgsH7opx/exec";
    
    let allInventoryData = []; 
    let allTransactionData = []; 
    let salesChart;

    // Helper to format date consistently for comparison
    function getFormatDate(dateObj) {
        if (!dateObj || isNaN(dateObj.getTime())) return null;
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
        const d = String(dateObj.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    // Helper to clean and parse amounts
    function parseAmount(val) {
        if (!val) return 0;
        const cleaned = String(val).replace(/[â‚±,]/g, '').trim();
        return parseFloat(cleaned) || 0;
    }

    function changeBranch() {
        const selectedBranch = document.getElementById('branch-selector').value;
        document.getElementById('table-title').innerText = `Recent Sales: SM ${selectedBranch.replace('_', ' ')}`;
        document.getElementById('inventory-table-body').innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 50px; color: #888;">Loading ${selectedBranch} data...</td></tr>`;
        fetchInventory(); 
    }

    function openSheet() {
        const branch = document.getElementById('branch-selector').value;
        window.open(BRANCH_CONFIG[branch].sheetUrl, '_blank');
    }

    async function fetchInventory() {
        const branch = document.getElementById('branch-selector').value;
        const syncStatus = document.getElementById('sync-status');
        const apiURL = BRANCH_CONFIG[branch].url;

        syncStatus.innerText = "Syncing " + branch + "...";

        try {
            const response = await fetch(apiURL);
            const data = await response.json();
            
            allInventoryData = data.inventory || data;
            allTransactionData = (data.transactions || []).reverse(); 
            
            renderTable(allTransactionData);
            updateStats(allInventoryData, allTransactionData);
            updateChart(allTransactionData);
            
            syncStatus.innerText = "â— " + branch + " Live";
            syncStatus.style.color = "#2ecc71";
            checkPendingCount();
        } catch (error) {
            syncStatus.innerText = "Connection Error";
            syncStatus.style.color = "#e74c3c";
        }
    }

    function setDefaultDates() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date-selector').value = `${year}-${month}-${day}`;
        document.getElementById('month-selector').value = `${year}-${month}`;
    }

    async function checkPendingCount() {
        try {
            const response = await fetch(`${PENDING_API_URL}?action=getAdminData`);
            const data = await response.json();
            const pendingItems = data.approvals ? data.approvals.filter(item => item.status === "PENDING") : [];
            const count = pendingItems.length;
            const mainBadge = document.getElementById('main-pending-badge');
            if (count > 0) {
                mainBadge.innerText = count;
                mainBadge.style.display = "inline-block";
            } else {
                mainBadge.style.display = "none";
            }
        } catch (e) { console.log("Pending check failed"); }
    }

    function renderTable(items) {
        const tableBody = document.getElementById('inventory-table-body');
        let html = "";
        if (!items || items.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">No matching transactions found.</td></tr>`;
            return;
        }
        items.slice(0, 50).forEach(item => {
            const dateObj = new Date(item.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', {
                year: 'numeric', month: '2-digit', day: '2-digit'
            });
            const amount = parseAmount(item.total);

            html += `<tr>
                <td>${formattedDate}</td>
                <td style="font-family:monospace; font-weight:bold;">${item.si || '---'}</td>
                <td>${item.name || '---'}</td>
                <td style="font-weight:bold; color: #3498db;">â‚±${amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
            </tr>`;
        });
        tableBody.innerHTML = html;
    }

    function updateStats(invItems, transItems) {
        document.getElementById('stat-total-items').innerText = invItems.length;
        const selectedDateRaw = document.getElementById('date-selector').value;
        const selectedMonthRaw = document.getElementById('month-selector').value;
        
        let salesSelectedDay = 0;
        let salesSelectedMonth = 0;

        transItems.forEach(t => {
            const d = new Date(t.date);
            const tDateStr = getFormatDate(d);
            if (!tDateStr) return;

            const tMonthStr = tDateStr.substring(0, 7);
            const amount = parseAmount(t.total);

            if (tDateStr === selectedDateRaw) salesSelectedDay += amount;
            if (tMonthStr === selectedMonthRaw) salesSelectedMonth += amount;
        });

        document.getElementById('stat-sales-today').innerText = `â‚±${salesSelectedDay.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('stat-sales-month').innerText = `â‚±${salesSelectedMonth.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function updateChart(transItems) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        const last7DaysLabels = [];
        const last7DaysKeys = [];
        const salesData = [];

        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            last7DaysLabels.push(d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            last7DaysKeys.push(getFormatDate(d));
        }

        last7DaysKeys.forEach(key => {
            let dailyTotal = 0;
            transItems.forEach(t => {
                if (getFormatDate(new Date(t.date)) === key) {
                    dailyTotal += parseAmount(t.total);
                }
            });
            salesData.push(dailyTotal);
        });

        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: last7DaysLabels,
                datasets: [{
                    label: 'Daily Sales (â‚±)',
                    data: salesData,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: { 
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredData = allTransactionData.filter(item => {
            const name = (item.name || "").toLowerCase();
            const si = (item.si || "").toLowerCase();
            return name.includes(searchTerm) || si.includes(searchTerm);
        });
        renderTable(filteredData);
    }

    window.onload = function() {
        setDefaultDates();
        fetchInventory();
        setInterval(checkPendingCount, 120000);
    };
</script>
</body>
</html>